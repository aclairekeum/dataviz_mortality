<!DOCTYPE html>
<html>
  
  <head>
    
    <meta charset="utf-8">
    <title>Mortality Visualization</title>

    <!-- load D3 library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <style>
    </style>

  </head>
  
  <body>


    <div>
      <svg id="viz-months" width="500" height="500" style=" display:inline-block;">
      </svg>
      <svg id="viz-genders" width="500" height="300" style=" display:inline-block;">
      </svg>
      <svg id="viz-education" width="500" height="500" style=" display:inline-block;">
      </svg>
    </div>

    <script>


/*
 * Demo: Mortality 2008/2013
 * 
 */


// Call run when the page finishes loading
      
window.addEventListener("load",run);


var GLOBAL = {};

function run () {
  var svg = d3.selectAll("svg");
  svg.append("text")
	.attr("class","loading")
	.attr("x",+svg.attr("width")/2)
	.attr("y",+svg.attr("height")/2)
	.attr("dy","0.35em")
	.style("text-anchor","middle")
	.text("loading data...");

  getData(function(data) {
	GLOBAL.data = data;
	createMonthsView(data);
	createGendersView(data);
	createEduView(data);
    });
}


/*
 * Functions for summing up totals from the
 * data
 * 
 */

 function sumTotal (data, pred) {
    var total = 0;
    data.forEach(function(r) {
	if (pred(r)) { 
	    total += +r["total"]
	}
    });
    return total;
}

function sumTotalByGender (data,g)  {
    return sumTotal(data,
        function(r) { return r.gender===g; });
}

function sumTotalByEdu (data, e){
  return sumTotal(data, 
    function(r){ return r.education === e 
              ;});
}

function sumTotalByMonth (data, m)  {
    return sumTotal(data,
        function(r) { return r.month===m; });
}

function sumTotalByEduGender(data,e,g){
  return sumTotal(data, 
    function(r){ return r.education === e &&
              r.gender===g;
              });
}

function sumTotalByEduMonth (data, e,m){
  return sumTotal(data, 
    function(r){ return r.education === e &&
              r.month === m;});
}

function sumTotalByGenderMonth (data, g,m){
  return sumTotal(data, 
    function(r){ return r.gender === g &&
              r.month === m;});
}

function sumTotalByEduGenderMonth (data, e,g,m){
	return sumTotal(data, 
		function(r){ return r.education === e &&
							r.gender === g &&
							r.month === m;});
}




/* 
 * Create a simple visual representation
 * of the data
 *
 */
function createMonthsView(data){
  console.log("createMonthsView")
    updateMonthsView(data);
}

function updateMonthsView(data, gender, edu){
  console.log("updateMonthsView");
    var month =data.months;
    var data = data.data;
    var total_month = [];
    var row_val = 0;
    var col_val = 0;
    var month_list = ["J", "F", "M", "A", "M", "J", "J", "A", "S", "O","N","D"];

    if (typeof gender !== "undefined") {
      for(i = 0; i <= month.length-1; i++){
        if (i%3 == 0)
          {row_val += 1;
          col_val = 0;}
        else
          {col_val += 1;
          }
        total_month.push({value:sumTotalByGenderMonth(data, gender, month[i]), row:row_val, col:col_val, month:month_list[i], sex:gender});
        // console.log(sumTotalByGenderMonth(data, gender, month[i]));
      }
     } 
     else if (typeof edu !== "undefined"){
      for(i = 0; i <= month.length-1; i++){
        if (i%3 == 0)
          {row_val += 1;
          col_val = 0;}
        else
          {col_val += 1;
          }
        total_month.push({value:sumTotalByEduMonth(data, edu, month[i]), row:row_val, col:col_val, month:month_list[i], sex:gender});
        // console.log(sumTotalByGenderMonth(data, gender, month[i]));
      }
     } 
    else {
        for(i = 0; i <= month.length-1; i++){
          if (i %3 ==0)
            {row_val += 1;
            col_val = 0;}
          else
            {col_val += 1;}
          total_month.push({value:sumTotalByMonth(data, month[i]),row:row_val, col:col_val, month:month_list[i]});
          
        }
    };
    
  console.log(total_month);

//height of each row in the heatmap
//width of each column in the heatmap
  var month_values = [];
  for(i = 0; i< total_month.length; i++)
  {
    month_values.push(total_month[i].value)
    //console.log(total_month[i].value);
  }

  var gridSize = 76,
      h = gridSize,
      w = gridSize,
      rectPadding = 10;

    var colorLow = '#70C062', colorMed = '#698267', colorHigh = '#000000';

  var margin = {top: 20, right: 20, bottom: 20, left: 20},
      width = 300,
      height = 500;



  var colorScale = d3.scale.linear()
       .domain([Math.min.apply(Math,month_values), (Math.max.apply(Math,month_values)+Math.min.apply(Math,month_values))/2, Math.max.apply(Math,month_values)])
       .range([colorLow, colorMed, colorHigh]);

  var svg = d3.select("#viz-months");

  var g = svg.selectAll("g")
    .data(total_month)
    .enter()
    .append("g");
    
  var heatMap = g.append("rect");

    heatMap.attr("x", function(d) { return d.col * h; })
    .attr("y", function(d) { return d.row * w; })
    .attr("width", function(d) { return w; })
    .attr("height", function(d) { return h; })
    .attr("stroke", "white")
    .attr("stroke-width",0.5)
    
  g.append("text")
       .text(function(d) { return String(d.month); })
      .attr("x", function(d) { return d.col * h +gridSize/2; })
      .attr("y", function(d) { return d.row * w +gridSize/2; })
       .style("text-anchor", "middle")
       .style("fill","white")
       .style("font-family","fantasy")
      .style("font-weight","bold")
      .style("font-size","18px");

  g.data(total_month).enter();

  heatMap.transition()
  .style("fill", function(d) { return colorScale(d.value); });
  }   

function createEduView (data) {

   var svg = d3.select("#viz-education");

  svg.append("text")
	.attr("x",+svg.attr("width")/2)
	.attr("y",20)
	.attr("dy","0.35em")
	.style("text-anchor","middle")
	.style("font-family","fantasy")
	.style("font-size","20pt")
	.text("Education");


  updateEduView(data);

}

function updateEduView (data, gender, month) {

  console.log("update edu received", gender);
   var svg = d3.select("#viz-education")

   var height= svg.attr("height")
   var width = svg.attr("width")
   
   sel = svg
   .append("g")
   .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

   //Add update MonthView
   var educations = data.educations;
   // console.log(educations)
   var data = data.data;
   var r = svg.attr("height") / 2.5;

   
   if (typeof gender !== "undefined") {
	var d = educations.map(function(e) {
	    return {edu:e,
		    value:sumTotalByEduGender(data, e, gender)};
	});
    } else {
	var d = educations.map(function(e) {
	    return {edu:e,
		    value:sumTotalByEdu(data, e)};
	});
    }	
   
   d.sort(function(x, y){
   return d3.ascending(x.edu, y.edu);
	});

   // console.log(d);
   var color = d3.scale.category20();
   // Using d3 layout
   var pie = d3.layout.pie()
   .value(function(d){return d.value;})
   .sort(function(a,b) {return d3.ascending(a.edu,b.edu); });
   // .sort(function(a,b) { return d3.ascending(a.edu,b.edu);} );

   var arc = d3.svg.arc()
   .outerRadius(r)
   .innerRadius(70);
  
   var text;
   var stroke; 

   var g = svg.selectAll("g.arc")
   .data(pie(d))
   .enter()
   .append("g")
   .attr("class","arc")
   .attr("transform", "translate(" + width/2 + "," + height/2 + ")");

   g.append("path")
   .attr("stroke", "white")
   .attr("stroke-width", 0.5)
   .each(function(d) { this._current = d; })
   .attr("fill", function(d, i) { return color(i); })
   .attr("d",arc);

    g.on("mouseenter",function (d,i) {  
    d3.select(this).select("path").style("opacity", 0.5);
     
      text = g.append("text")
     .attr("dy", ".35em")
     .style("font-family","fantasy")
     .attr("text-anchor", "middle")
     .text(EDUCATION[i])
     .style("fill","black");
     updateGendersView(GLOBAL.data,i);
     console.log("should update gender sent");
     // console.log(EDUCATION[i],i);
  // updateMonthsView(GLOBAL.data,GLOBAL.data.genders[i]);
    });

    g.on("mouseout", function(d) {
    d3.select(this).select("path").style("opacity", 1);
    updateGendersView(GLOBAL.data);
    text.remove();
    });

  //Update Code
   g = svg.selectAll("g.arc");
   g.select("path").transition()
   .duration(500)
   .attrTween("d", arcChange);

   function arcChange(a) {
    // console.log('arcChange');
   var i = d3.interpolate(this._current, a);
   this._current = i(0);
   return function(t) {
   return arc(i(t));
   }
  }

}

/*
 * Move a DOM element to the front 
 *
 */
function moveToFront (node) {
    var parent = node.parentNode;
    parent.appendChild(node);
}
    
function updateGendersView (data,edu) { 

    console.log("update gender received");
    var genders = data.genders;
    // var month = data.months;
    var data = data.data;

    total_genders = [];
    var totalnum  =0;

    if (typeof edu !== "undefined") {
      for (var i = 0; i < 2; i++) {
        total_genders.push({value:sumTotalByEduGender(data, edu, genders[i]),sex:genders[i]});
      }} 
  else {
    for (var i = 0; i < 2; i++) {
      total_genders.push({value:sumTotalByGender(data, genders[i]), sex:genders[i]});}
      };

    var totalnum  =0;
    for (var i =0; i<2; i++){
      totalnum +=total_genders[i].value;
    }

    console.log("total genders: ", total_genders, "total:", totalnum);
    var svg = d3.select("#viz-genders");

    var height = svg.attr("height");
    var width = svg.attr("width");

    var margin = 50;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var padding = 5; 
    var barWidth= chartWidth/total_genders.length - padding;

    var g = svg.selectAll('g')
      .data(total_genders)
      .enter()
      .append('g');
    
    g.append("rect")
      .attr('x', function(d, i){return margin+i*chartWidth/total_genders.length;})
      .attr('width', barWidth)
      .attr('fill', "#698267");

    g.append("text")
    .attr("x",function(d, i){return margin+barWidth/2+i*chartWidth/total_genders.length;})
    .attr("dy","0.3em")
    .style("text-anchor","middle")
    .style("font-family","fantasy")
    .style("font-weight","bold")
    .style("font-size","12px")
    .style("fill", "white")
    
    g = svg.selectAll("g");
    g.select("rect").transition()
    .attr('height', function(d){return d.value*100.0/totalnum;})
    .attr("y",function(d) { return chartHeight- d.value*100.0/totalnum;});
 
    g.select("text").transition()
    .attr("y",function(d) {return chartHeight- d.value*100.0/totalnum +10;})
    .text(function(d){return d.sex + " " + Math.round(d.value*100.0/totalnum) + "%";})
    // .text(function(d){return d.sex});

    g.on("mouseenter", function(d,i){
      d3.select(this).select("rect").style("fill","#70C062");
     updateEduView(GLOBAL.data,d.sex);
     updateMonthsView(GLOBAL.data,d.sex);
     console.log("update months sent", d.sex);
   });

   g.on("mouseout", function(d) {
    d3.select(this).select("rect").style("fill","#698267");
    updateEduView(GLOBAL.data);
    updateMonthsView(GLOBAL.data);
    });

   }
   

function createGendersView (data) {

    var svg = d3.select("#viz-genders");

    svg.append("text")
  .attr("x",+svg.attr("width")/2)
  .attr("y",20)
  .attr("dy","0.35em")
  .style("text-anchor","middle")
  .style("font-family","fantasy")
  .style("font-size","20pt")
  .text("Genders");

    updateGendersView(data);

}


var EDUCATION = {
	"0": "No formal education",
	"1": "1 Year(s) of elementary school",
	"2": "2 Year(s) of elementary school",
	"3": "3 Year(s) of elementary school",
	"4": "4 Year(s) of elementary school",
	"5": "5 Year(s) of elementary school",
	"6": "6 Year(s) of elementary school",
	"7": "7 Year(s) of elementary school",
	"8": "8 Year(s) of elementary school",
	"9": "1 year of high school",
	"10": "2 years of high school",
	"11": "3 years of high school",
	"12": "4 years of high school",
	"13": "1 year of college",
	"14": "2 years of college",
	"15": "3 years of college",
	"16": "4 years of college",
	"17": "5 or more years of college",
	// "99": "Not stated",
	"": "Not on certificate"
}


function getData (f) {

    d3.json("data",function(error,data) {
		 if (error) {
		     d3.selectAll(".loading").remove();
		     console.log(error);
		 } else {
		     d3.selectAll(".loading").remove();
		     console.log(" data =", data);
		     f(data);
		 }
	     });
}
      
    </script>
    
  </body>
  
</html>
